<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="monsterball.jpg" type="image/x-icon">
  <title>포켓몬 도감 Pro</title>
  <style>
       @font-face {
      font-family: "CAFE24-PRO-UP";
      src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/2507-1@1.0/Cafe24PROUP.woff2")
        format("woff2");
      font-weight: normal;
      font-display: swap;
    }
    :root {
      --main-color: #5E739F;
      --sub-color: #C5D0E9;
      --text-color: #333;
      --card-bg-color: #fff;
      --font-family: "NeoDunggeunmoCode", sans-serif;
    }

    body {
      font-family: "CAFE24-PRO-UP";
      background-color: #f3f7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }


    /* 검색창 */
    #search-form {
      display: flex; gap: 0.5rem; margin-bottom: 2rem;
    }
    #search-form input {
      padding: 0.5rem 1rem; border: 2px solid var(--main-color); border-radius: 0.5rem; font-size: 1rem; width: 200px;
    }
    #search-form button {
      padding: 0.5rem 1.2rem; background-color: var(--main-color); color: white; border: none; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; font-family: var(--font-family);
    }
    #search-form button:hover { background-color: #4A5B7F; }

    /* 도감 카드 */
    .pokedex-card-container {
        position: relative;
    }
    .pokedex-card {
      width: 340px; border: 5px solid var(--main-color); background-color: var(--main-color); border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; flex-direction: column; text-align: center;
    }

    /* 로딩 스피너 */
    .loader {
        border: 5px solid #f3f3f3; border-top: 5px solid var(--main-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 4rem auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 헤더 */
    .poke-header {
      background-color: var(--main-color); color: white; padding: 1rem; border-top-left-radius: 0.7rem; border-top-right-radius: 0.7rem; display: flex; justify-content: space-between; align-items: flex-start;
    }
    .poke-name-group { text-align: left; }
    .poke-koname { font-size: 2.2rem; margin-bottom: 0.3rem; color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
    .poke-jpname, .poke-enname { font-size: 1.1rem; color: var(--sub-color); letter-spacing: 1px; }
    .poke-number { background-color: var(--card-bg-color); border: 2px solid var(--main-color); border-radius: 0.5rem; padding: 0.3rem 0.8rem; color: var(--text-color); font-size: 1.1rem; flex-shrink: 0; margin-top: 5px; }
    
    /* 바디 */
    .poke-body { background-color: var(--card-bg-color); padding: 0.5rem 1rem; }
    .poke-image-container { position: relative; width: 200px; height: 200px; margin: 0 auto; }
    .poke-img { width: 100%; height: 100%; object-fit: contain; }
    .interactive-buttons { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 5px; }
    .interactive-buttons button { background: rgba(255, 255, 255, 0.7); border: 1px solid #ccc; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1rem; display: grid; place-items: center; backdrop-filter: blur(2px); }
    .interactive-buttons button:hover { background: rgba(255, 255, 255, 1); }
    
    .poke-flavor-text { font-size: 0.9rem; padding: 1rem; margin: 0.5rem 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; color: #555; }
    
    /* 레이아웃 수정: 2열 -> 3열 */
    .poke-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; text-align: center; }
    .detail-box { display: flex; flex-direction: column; gap: 0.3rem; }
    .detail-box h4 { margin: 0; font-size: 1rem; color: var(--main-color); }
    .detail-box p { margin: 0; font-size: 1.1rem; word-break: keep-all; }
    
    .poke-stats-container h4 { margin: 1rem 0 0.5rem 0; text-align: center; color: var(--main-color); }
    .stat-row { display: flex; align-items: center; margin-bottom: 0.3rem; font-size: 0.9rem; }
    .stat-name { width: 90px; text-align: right; padding-right: 10px; }
    .stat-bar-container { flex: 1; background: #eee; border-radius: 5px; height: 15px; }
    .stat-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-in-out; }
    
    /* 푸터 */
    .poke-footer { display: flex; background-color: var(--main-color); padding: 0.7rem; }
    .info-box { flex: 1; display: flex; flex-direction: column; align-items: center; color: white; }
    .info-label { font-size: 1rem; margin-bottom: 0.3rem; }
    .info-content { background: var(--card-bg-color); width: 90%; min-height: 30px; padding: 0.5rem; border-radius: 0.8rem; color: var(--text-color); font-size: 1.2rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .type-badge { padding: 0.3rem 0.6rem; border-radius: 0.5rem; font-size: 0.9rem; color: white; text-transform: uppercase; }

    /* 진화 과정 */
    .poke-evolution-container { background-color: #e9eef5; padding: 1rem; border-bottom-left-radius: 0.7rem; border-bottom-right-radius: 0.7rem; }
    .poke-evolution-container h3 { margin: 0 0 0.5rem 0; color: var(--main-color); font-size: 1.2rem; }
    .evolution-chain { display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .evolution-stage { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .evolution-stage img { width: 70px; height: 70px; image-rendering: pixelated; }
    .evolution-stage p { margin: 0; font-size: 0.9rem; }
    .evolution-arrow { font-size: 1.5rem; color: var(--main-color); }
    
    /* 네비게이션 버튼 */
    .nav-button { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; transition: background-color 0.2s; z-index: 10; }
    .nav-button:hover { background-color: rgba(0,0,0,0.6); }
    .nav-button:disabled { background-color: rgba(0,0,0,0.1); cursor: not-allowed; }
    .prev { left: -50px; }
    .next { right: -50px; }

    /* 타입별 색상 */
    .type-fire { background: #F4823A; } .type-water { background: #6890F0; } .type-grass { background: #78C850; } .type-electric { background: #F8D030; } .type-ice { background: #98D8D8; } .type-fighting { background: #C55A54; } .type-poison { background: #A040A0; } .type-ground { background: #E0C068; } .type-flying { background: #A890F0; } .type-psychic { background: #F85888; } .type-bug { background: #A8B820; } .type-rock { background: #B8A038; } .type-ghost { background: #705898; } .type-dragon { background: #7038F8; } .type-dark { background: #705848; } .type-steel { background: #B8B8D0; } .type-fairy { background: #EE99AC; } .type-normal { background: #A8A878; }
  </style>
</head>
<body>
  <form id="search-form">
    <input type="text" id="poke-input" placeholder="번호 / 이름 입력"/>
    <button>검색</button>
  </form>

  <div class="pokedex-card-container">
    <div id="pokedex" class="pokedex-card">
      </div>

    <button id="prev-pokemon" class="nav-button prev" disabled>◀</button>
    <button id="next-pokemon" class="nav-button next" disabled>▶</button>
  </div>

<script>
    const POKE_API_BASE = "https://pokeapi.co/api/v2";
    const MAX_POKEMON_ID = 1025; // 현재 API가 지원하는 최대 포켓몬 ID

    // DOM 요소
    const searchForm = document.getElementById("search-form");
    const pokeInput = document.getElementById("poke-input");
    const pokedexCard = document.getElementById("pokedex");
    const prevButton = document.getElementById("prev-pokemon");
    const nextButton = document.getElementById("next-pokemon");

    // 포켓몬 데이터 상태 저장
    let currentPokemon = {};

    const typeTranslations = { normal: "노말", fire: "불", water: "물", grass: "풀", electric: "전기", ice: "얼음", fighting: "격투", poison: "독", ground: "땅", flying: "비행", psychic: "에스퍼", bug: "벌레", rock: "바위", ghost: "고스트", dragon: "드래곤", dark: "악", steel: "강철", fairy: "페어리" };

    // --- 데이터 가져오기 ---
    async function fetchApi(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        return response.json();
    }

    // --- 한글 이름 → ID 변환 함수 ---
    async function changeNameToId(name) {
        let nameToId = JSON.parse(localStorage.getItem("nameToId"));
        if (!nameToId) {
            pokedexCard.style.display = "flex";
            pokedexCard.innerHTML = `<p style="padding: 2rem;">초기 데이터를 불러오는 중입니다.<br>잠시만 기다려주세요...</p><div class="loader"></div>`;
            
            const pokeLength = MAX_POKEMON_ID;
            nameToId = {};
            const promises = [];
            for (let i = 1; i <= pokeLength; i++) {
                promises.push(fetchApi(`${POKE_API_BASE}/pokemon-species/${i}`).catch(err => null));
            }
            const results = await Promise.all(promises);

            for(const speciesData of results) {
                if(speciesData) {
                    const koNameEntry = speciesData.names.find((n) => n.language.name === "ko");
                    if (koNameEntry) {
                        nameToId[koNameEntry.name] = speciesData.id;
                    }
                }
            }
            localStorage.setItem("nameToId", JSON.stringify(nameToId));
        }
        return nameToId[name] || null;
    }

    // --- 주요 검색 함수 ---
    async function searchForPokemon(identifier) {
        pokedexCard.style.display = "flex";
        pokedexCard.innerHTML = `<div class="loader"></div>`;
        prevButton.disabled = true;
        nextButton.disabled = true;

        try {
            const pokemonData = await fetchApi(`${POKE_API_BASE}/pokemon/${identifier.toString().toLowerCase()}`);
            const speciesData = await fetchApi(pokemonData.species.url);

            currentPokemon = {
                id: pokemonData.id,
                name: pokemonData.name,
                sprites: {
                    default: pokemonData.sprites.other['official-artwork'].front_default,
                    shiny: pokemonData.sprites.other['official-artwork'].front_shiny
                },
                cries: pokemonData.cries.latest
            };

            renderPokemonCard(pokemonData, speciesData);
            updateNavButtons();
        } catch (error) {
            console.error("Error fetching Pokémon data:", error);
            pokedexCard.innerHTML = `<p style="padding: 2rem;">포켓몬을 찾을 수 없습니다!</p>`;
        }
    }

    // --- 렌더링 함수들 ---
    async function renderPokemonCard(data, speciesData) {
        pokedexCard.innerHTML = `
            ${createHeaderHTML(data, speciesData)}
            ${createBodyHTML(data, speciesData)}
            ${createFooterHTML(data, speciesData)}
            ${await createEvolutionHTML(speciesData)}
        `;
        setupInteractiveButtons();
        setTimeout(() => renderStatBars(data.stats), 0);
    }
    
    function createHeaderHTML(data, speciesData) {
        const koName = speciesData.names.find(n => n.language.name === 'ko')?.name || data.name;
        const jpName = speciesData.names.find(n => n.language.name === 'ja-Hrkt')?.name || '';
        const enName = data.name.charAt(0).toUpperCase() + data.name.slice(1);

        return `
            <div class="poke-header">
              <div class="poke-name-group">
                <div class="poke-koname">${koName}</div>
                <div class="poke-jpname">${jpName}</div>
                <div class="poke-enname">${enName}</div>
              </div>
              <div class="poke-number">No.${String(data.id).padStart(3, '0')}</div>
            </div>
        `;
    }

    function createBodyHTML(data, speciesData) {
        const flavorText = speciesData.flavor_text_entries.find(entry => entry.language.name === 'ko')?.flavor_text || "이 포켓몬에 대한 설명이 아직 없습니다.";
        const height = data.height / 10; // m
        const weight = data.weight / 10; // kg
        const abilities = data.abilities.map(a => a.ability.name.charAt(0).toUpperCase() + a.ability.name.slice(1)).join(', ');
        const statNameToKo = { 'hp': 'HP', 'attack': '공격', 'defense': '방어', 'special-attack': '특수공격', 'special-defense': '특수방어', 'speed': '스피드' };
        
        return `
            <div class="poke-body">
                <div class="poke-image-container">
                    <img id="poke-img" class="poke-img" src="${currentPokemon.sprites.default || './placeholder.png'}" alt="${data.name}">
                    <div class="interactive-buttons">
                        <button id="shiny-toggle" title="반짝이 모습 보기" style="display: ${currentPokemon.sprites.shiny ? 'grid' : 'none'};">✨</button>
                        <button id="play-cry" title="울음소리 듣기">🔊</button>
                    </div>
                </div>
                <p class="poke-flavor-text">${flavorText.replace(/\n/g, ' ')}</p>
                <div class="poke-details-grid">
                    <div class="detail-box"><h4>키</h4><p>${height} m</p></div>
                    <div class="detail-box"><h4>몸무게</h4><p>${weight} kg</p></div>
                    <div class="detail-box"><h4>특성</h4><p>${abilities}</p></div>
                </div>
                <div class="poke-stats-container">
                    <h4>능력치</h4>
                    ${data.stats.map(stat => `
                        <div class="stat-row">
                            <span class="stat-name">${statNameToKo[stat.stat.name] || stat.stat.name}</span>
                            <div class="stat-bar-container"><div class="stat-bar" data-stat-value="${stat.base_stat}"></div></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function createFooterHTML(data, speciesData) {
        const types = data.types.map(t => `<span class="type-badge type-${t.type.name}">${typeTranslations[t.type.name] || t.type.name}</span>`).join('');
        const genus = speciesData.genera.find(g => g.language.name === 'ko')?.genus || "알 수 없음";

        return `
            <div class="poke-footer">
                <div class="info-box"><span class="info-label">타입</span><div class="info-content">${types}</div></div>
                <div class="info-box"><span class="info-label">분류</span><div class="info-content">${genus}</div></div>
            </div>
        `;
    }
    
    async function createEvolutionHTML(speciesData) {
        if (!speciesData.evolution_chain?.url) return '<div class="poke-evolution-container"><h3>진화 정보 없음</h3></div>';
        
        const evolutionData = await fetchApi(speciesData.evolution_chain.url);
        const chain = await parseEvolutionChain(evolutionData.chain);
        const evolutionStages = chain.map(pokemon => `
            <div class="evolution-stage" data-name="${pokemon.name}" title="${pokemon.koName} 정보 보기">
                <img src="${pokemon.sprite || ''}" alt="${pokemon.name}">
                <p>${pokemon.koName}</p>
            </div>
        `).join('<div class="evolution-arrow">→</div>');

        return `
            <div class="poke-evolution-container">
                <h3>진화 과정</h3>
                <div class="evolution-chain">${chain.length > 1 ? evolutionStages : '<p>이 포켓몬은 진화하지 않습니다.</p>'}</div>
            </div>
        `;
    }
    
    async function parseEvolutionChain(chain) {
        const evolutionLine = [];
        let currentStage = chain;
        
        while (currentStage) {
            const speciesName = currentStage.species.name;
            evolutionLine.push({ name: speciesName });
            currentStage = currentStage.evolves_to[0];
        }

        const promises = evolutionLine.map(async (pokemon) => {
            const pData = await fetchApi(`${POKE_API_BASE}/pokemon/${pokemon.name}`);
            const sData = await fetchApi(pData.species.url);
            pokemon.sprite = pData.sprites.front_default;
            pokemon.koName = sData.names.find(n => n.language.name === 'ko')?.name || pokemon.name;
        });

        await Promise.all(promises);
        return evolutionLine;
    }
    
    function renderStatBars(stats) {
        const statBars = document.querySelectorAll('.stat-bar');
        statBars.forEach(bar => {
            const value = parseInt(bar.dataset.statValue, 10);
            const percentage = (value / 255) * 100;
            bar.style.width = `${percentage}%`;
            
            if (value < 60) bar.style.backgroundColor = '#f37272';
            else if (value < 90) bar.style.backgroundColor = '#f3d372';
            else bar.style.backgroundColor = '#72f372';
        });
    }

    function setupInteractiveButtons() {
        const shinyToggle = document.getElementById('shiny-toggle');
        if (shinyToggle) {
            let isShiny = false;
            shinyToggle.addEventListener('click', () => {
                isShiny = !isShiny;
                document.getElementById('poke-img').src = isShiny ? currentPokemon.sprites.shiny : currentPokemon.sprites.default;
            });
        }
        
        const playCry = document.getElementById('play-cry');
        if (playCry) {
            playCry.addEventListener('click', () => {
                if(currentPokemon.cries) {
                    const cry = new Audio(currentPokemon.cries);
                    cry.play();
                }
            });
        }

        document.querySelectorAll('.evolution-stage').forEach(stage => {
            stage.addEventListener('click', () => {
                const pokemonName = stage.dataset.name;
                if(pokemonName !== currentPokemon.name) {
                    pokeInput.value = pokemonName;
                    searchForPokemon(pokemonName);
                }
            });
        });
    }
    
    function updateNavButtons() {
        prevButton.disabled = currentPokemon.id <= 1;
        nextButton.disabled = currentPokemon.id >= MAX_POKEMON_ID;
    }

    // --- [수정됨] 이벤트 리스너 (검색 로직 변경) ---
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const searchTerm = pokeInput.value.trim();
        if (!searchTerm) return;

        // 한글 정규식
        const isKorean = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;

        if (isKorean.test(searchTerm)) {
            // 한글이면 ID로 변환 후 검색
            const pokeId = await changeNameToId(searchTerm);
            if (pokeId) {
                searchForPokemon(pokeId);
            } else {
                pokedexCard.style.display = 'flex';
                pokedexCard.innerHTML = `<p style="padding: 2rem;">포켓몬을 찾을 수 없습니다!</p>`;
            }
        } else {
            // 한글이 아니면 숫자 또는 영어로 간주하고 바로 검색
            searchForPokemon(searchTerm);
        }
    });

    prevButton.addEventListener('click', () => {
        if (currentPokemon.id > 1) {
            pokeInput.value = currentPokemon.id - 1;
            searchForPokemon(currentPokemon.id - 1);
        }
    });

    nextButton.addEventListener('click', () => {
        if (currentPokemon.id < MAX_POKEMON_ID) {
            pokeInput.value = currentPokemon.id + 1;
            searchForPokemon(currentPokemon.id + 1);
        }
    });
</script>
</body>
</html>